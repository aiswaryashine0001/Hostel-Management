<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Hostel Management System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/admin_dashboard}">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/admin_dashboard}">Dashboard</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/api/logout}">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

<div class="container-fluid mt-4">
    <!-- Admin Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h2 class="card-title mb-0">
                        <i class="fas fa-cogs"></i> Admin Dashboard
                    </h2>
                    <p class="card-text">Manage students, rooms, and allocations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h3 id="totalStudents">0</h3>
                    <p>Total Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-bed fa-3x mb-3"></i>
                    <h3 id="totalRooms">0</h3>
                    <p>Total Rooms</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-home fa-3x mb-3"></i>
                    <h3 id="allocatedRooms">0</h3>
                    <p>Allocated Students</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <i class="fas fa-clock fa-3x mb-3"></i>
                    <h3 id="pendingAllocations">0</h3>
                    <p>Pending Allocations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                <i class="fas fa-users"></i> Students
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button" role="tab">
                <i class="fas fa-bed"></i> Rooms
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="allocations-tab" data-bs-toggle="tab" data-bs-target="#allocations" type="button" role="tab">
                <i class="fas fa-home"></i> Allocations
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-4" id="adminTabContent">
        <!-- Students Tab -->
        <div class="tab-pane fade show active" id="students" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Student Management</h5>
                    <button class="btn btn-sm btn-primary" onclick="refreshStudents()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>Preferences</th>
                                    <th>Room</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">Loading students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rooms Tab -->
        <div class="tab-pane fade" id="rooms" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Room Management</h5>
                    <div>
                        <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                            <i class="fas fa-plus"></i> Add Room
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="refreshRooms()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Room Number</th>
                                    <th>Building</th>
                                    <th>Floor</th>
                                    <th>Capacity</th>
                                    <th>Occupied</th>
                                    <th>Status</th>
                                    <th>Amenities</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">Loading rooms...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Allocations Tab -->
        <div class="tab-pane fade" id="allocations" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Room Allocation System</h5>
                    <button class="btn btn-success" onclick="runAllocation()">
                        <i class="fas fa-magic"></i> Run Smart Allocation
                    </button>
                </div>
                <div class="card-body">
                    <div id="allocationResults" class="mb-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Allocation Results</h6>
                            <div id="allocationResultsContent"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Allocation Algorithm</h6>
                                    <p class="card-text small">
                                        Our smart allocation system considers:
                                    </p>
                                    <ul class="small">
                                        <li>Sleep and wake time compatibility</li>
                                        <li>Study habits and noise tolerance</li>
                                        <li>Cleanliness and social preferences</li>
                                        <li>Smoking and lifestyle compatibility</li>
                                        <li>Shared interests and hobbies</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Allocation Status</h6>
                                    <p id="allocationStatus" class="card-text">
                                        Ready to run allocation algorithm
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div class="modal fade" id="addRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRoomForm">
                        <div class="mb-3">
                            <label for="roomNumber" class="form-label">Room Number</label>
                            <input type="text" class="form-control" id="roomNumber" name="room_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="building" class="form-label">Building</label>
                            <input type="text" class="form-control" id="building" name="building" required>
                        </div>
                        <div class="mb-3">
                            <label for="floor" class="form-label">Floor</label>
                            <input type="number" class="form-control" id="floor" name="floor" required>
                        </div>
                        <div class="mb-3">
                            <label for="capacity" class="form-label">Capacity</label>
                            <select class="form-select" id="capacity" name="capacity" required>
                                <option value="1">1 Person</option>
                                <option value="2" selected>2 Persons</option>
                                <option value="3">3 Persons</option>
                                <option value="4">4 Persons</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amenities" class="form-label">Amenities</label>
                            <input type="text" class="form-control" id="amenities" name="amenities" 
                                   placeholder="e.g., WiFi, AC, Study Table">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addRoom()">Add Room</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    refreshStudents();
    refreshRooms();
});

async function loadDashboardStats() {
    try {
        const [studentsResponse, roomsResponse] = await Promise.all([
            fetch('/api/students'),
            fetch('/api/rooms')
        ]);
        
        if (studentsResponse.ok && roomsResponse.ok) {
            const studentsData = await studentsResponse.json();
            const roomsData = await roomsResponse.json();
            
            document.getElementById('totalStudents').textContent = studentsData.students.length;
            document.getElementById('totalRooms').textContent = roomsData.rooms.length;
            
            const allocated = studentsData.students.filter(s => s.room_id).length;
            document.getElementById('allocatedRooms').textContent = allocated;
            document.getElementById('pendingAllocations').textContent = studentsData.students.length - allocated;
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

async function refreshStudents() {
    try {
        const response = await fetch('/api/students');
        const data = await response.json();
        
        const tbody = document.getElementById('studentsTableBody');
        
        if (data.students && data.students.length > 0) {
            tbody.innerHTML = data.students.map(student => `
                <tr>
                    <td>${student.student_id}</td>
                    <td>${student.name}</td>
                    <td>${student.course || 'N/A'}</td>
                    <td>${student.year || 'N/A'}</td>
                    <td>
                        ${student.sleep_time ? 
                            '<span class="badge bg-success">Completed</span>' : 
                            '<span class="badge bg-warning">Pending</span>'
                        }
                    </td>
                    <td>
                        ${student.room_number ? 
                            `<span class="badge bg-info">${student.room_number}</span>` : 
                            '<span class="badge bg-secondary">Unallocated</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStudent(${student.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No students found</td></tr>';
        }
    } catch (error) {
        console.error('Error loading students:', error);
        showAlert('Error loading students', 'danger');
    }
}

async function refreshRooms() {
    try {
        const response = await fetch('/api/rooms');
        const data = await response.json();
        
        const tbody = document.getElementById('roomsTableBody');
        
        if (data.rooms && data.rooms.length > 0) {
            tbody.innerHTML = data.rooms.map(room => `
                <tr>
                    <td>${room.room_number}</td>
                    <td>${room.building || 'N/A'}</td>
                    <td>${room.floor || 'N/A'}</td>
                    <td>${room.capacity}</td>
                    <td>${room.occupied}</td>
                    <td>
                        ${room.occupied < room.capacity ? 
                            '<span class="badge bg-success">Available</span>' : 
                            '<span class="badge bg-danger">Full</span>'
                        }
                    </td>
                    <td class="small">${room.amenities || 'N/A'}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No rooms found</td></tr>';
        }
    } catch (error) {
        console.error('Error loading rooms:', error);
        showAlert('Error loading rooms', 'danger');
    }
}

async function addRoom() {
    const form = document.getElementById('addRoomForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/create_room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Room created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addRoomModal')).hide();
            form.reset();
            refreshRooms();
            loadDashboardStats();
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error creating room', 'danger');
    }
}

async function runAllocation() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Allocation...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/allocate_rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAllocationResults(result.results);
            showAlert(result.message, 'success');
            refreshStudents();
            loadDashboardStats();
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error running allocation', 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function showAllocationResults(results) {
    const resultsDiv = document.getElementById('allocationResults');
    const contentDiv = document.getElementById('allocationResultsContent');
    
    let html = `
        <p><strong>Allocation Summary:</strong></p>
        <ul>
            <li>Students Allocated: ${results.allocated_count}</li>
            <li>Total Students: ${results.total_students}</li>
        </ul>
    `;
    
    if (results.details && results.details.length > 0) {
        html += `
            <p><strong>Allocation Details:</strong></p>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Room</th>
                            <th>Compatibility Score</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        results.details.forEach(detail => {
            html += `
                <tr>
                    <td>${detail.student_name} (${detail.student_id})</td>
                    <td>${detail.room_number}</td>
                    <td>
                        <span class="badge ${detail.compatibility_score >= 80 ? 'bg-success' : 
                                           detail.compatibility_score >= 60 ? 'bg-warning' : 'bg-danger'}">
                            ${detail.compatibility_score}%
                        </span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

function viewStudent(studentId) {
    // This would show student details in a modal
    showAlert('Student details view coming soon!', 'info');
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script th:src="@{/js/utils.js}"></script>

</body>
</html>